# Модуль службы доставки и виджет

Данный модуль предназначен для интеграции с API Маршрута. 
В нем присутствует компонент, который позволяет выбирать  тип доставки и производит расчёт стоимости доставки заказа.

Далее представлена инструкция по его установке.

# 1) Распаковка и загрузка файлов
 
	1.1) Перейдите в раздел Администрирования [Контент] -> [Структура сайта] -> [Файлы и папки];

	1.2) Перейдите в /bitrix/modules и распакуйте туда папку marschroute из архива bitrix-module-master.zip.

# 2) Установка модуля

	2.1) Перейдите на страницу Управления модулями [Настройки] -> [Настройки продукта] -> [Модули];

	2.2) Напротив  модуля [Marschroute] нажмите кнопку <Установить>;

	2.3) В следующем окне, зажав Ctrl, выделите [Физическое лицо] и/или [Юридическое лицо],   
	поставьте [V] в поле <Добавить местоположение "Marschroute">, нажмите кнопку <Установить Модуль>;
	
	2.4) В списке модулей у [Marschroute] появится [Статус]: Установлен.

# 3) Настройка модуля

	3.1) Откройте в разделе Администрирование [Магазин] -> [Настройки] -> [Службы доставки];

	3.2) В Списке служб доставок выберете [Доставка Marchroute], двойной клик;
		3.2.1) На вкладке [Общие настройки] поставить [V] в поле <Активность>;
		3.2.2) На вкладке [Настройки] введите [Публичный ключ];

	3.3) Перейдите в раздел [Контент] -> [Структура сайта] -> [Файлы и папки] и откройте папку  
	/personal/order/make;

	3.4) Кликните правой клавишей мыши по строке с файлом index.php, выберите [Редактировать как HTML];	

	3.5) Из списка компонентов (если скрыт, то нужно раскрыть из правой части окна) раздела   
	[Магазин] -> [Marshcroute widget] перетащите элемент <Виджет расчета доставки>, нажмите <Сохранить>.

# 4) Настройка параметров синхронизации модуля 
 
Для синхронизации заказов Битрикс с ERP необходимо выбрать, в каком режиме будет работать система:   
либо стандартный способ запуска агентов Битрикса, либо [настроить cron-скрипт](https://github.com/marschroute/bitrix-module/blob/master/cron.md).

	4.1)  Настройка cron-скрипта. Параметры настройки могут быть заданы по своему желанию или взяты из  
	примера, который описан в документе "Инструкция по составлению cron-скрипта.md"
	
__Примечание:__     
	Скрипт запускайте только после полной настройки модуля.
		
# 5) Настройка параметров модуля

	5.1) Перейдите на страницу настройки  
	[Администрирование] -> [Настройки] -> [Настройки продукта] -> [Настройки модулей]
	
	5.2) В списке модулей выберите <Marschroute>
	
	5.3) Пояснение по настройке параметров:
		5.3.1)  Ставка НДС - ставка указывается в параметрах отправляемого заказа
		
		5.3.2) 	Публичный API - выдается каждому партнеру для работы с нашими API
		
		5.3.3)	Статус заказа для отправки - выбирается статус заказа, при котором заказ отправляется  
		в ERP
		
		5.3.4)  Способ оплаты наличными - выбирается способ оплаты наличными (заказ отправится с  
		параметром "наличные"), все остальные заказы будут отправляться с параметром "предоплаченный заказ"
		
		5.3.5)  Сопоставление статусов доставки. Каждому <Статусу> должен соответствовать ноль или  
		несколько <Статусов МАРШРУТ>. Если более чем одному <Статусу> соответствует один статус <Маршрут>,  
		то генерируется ошибка. При обновлении <Статусов Маршрут> и если они обновились в ERP, то заказам   
		выставляются соответствующие <Статусы> настройки модуля.
		
		5.3.6) Кнопка <Восстановление агента> позволяет восстановить работоспособность агента в случае   
		выполнения его в cron-скрипте с "фатальной" ошибкой.


### Список кастомных полей Битрикса

Эти поля понадобятся при передаче заказа через API Маршрута.

* MARSCHROUTE_STREET - улица
* MARSCHROUTE_HOUSE - дом
* MARSCHROUTE_BULDING - строение/корпус
* MARSCHROUTE_ROOM - квартира/офис
* MARSCHROUTE_INDEX - почтовый индекс
* MARSCHROUTE_DELIVERY_TIME - диапазон доставки
* MARSCHROUTE_PLACE_ID - идентификатор места доставки
* MARSCHROUTE_KLDR - номер КЛАДР города доставки
* MARSCHROUTE_DELIVERY_COST - стоимость доставки

